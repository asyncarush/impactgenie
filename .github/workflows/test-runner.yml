name: Test Runner Environment

on:
  workflow_dispatch:  # Allows manual triggering
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-environment:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: System Information
      run: |
        echo "Operating System Info:"
        lsb_release -a
        echo "-------------------"
        echo "Kernel Version:"
        uname -a
        echo "-------------------"
        echo "CPU Info:"
        lscpu
        echo "-------------------"
        echo "Memory Info:"
        free -h
        echo "-------------------"
        echo "Disk Space:"
        df -h
        echo "-------------------"
        echo "Ubuntu Version:"
        cat /etc/os-release
        echo "-------------------"
        echo "Node Version:"
        node --version
        echo "-------------------"
        echo "NPM Version:"
        npm --version

    - name: Setup Kubernetes Context
      env:
        KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      run: |
        # Install kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        
        # Create kube config directory
        mkdir -p $HOME/.kube
        
        # Decode and write kubeconfig
        echo "$KUBE_CONFIG_DATA" | base64 -d > $HOME/.kube/config
        
        # Test connection
        echo "Checking Kubernetes connection:"
        kubectl config view
        echo "-------------------"
        echo "Current Context:"
        kubectl config current-context
        echo "-------------------"
        echo "Cluster Info:"
        kubectl cluster-info
        echo "-------------------"
        echo "Namespaces:"
        kubectl get ns
        echo "-------------------"
        echo "Pods in current namespace:"
        kubectl get pods

    - name: Node.js Setup Check
      run: |
        echo "Node.js environment details:"
        node -e "console.log('Node.js Runtime:', process.version)"
        node -e "console.log('Architecture:', process.arch)"
        node -e "console.log('Platform:', process.platform)"
        node -e "console.log('OS Release:', require('os').release())"
        node -e "console.log('CPU Cores:', require('os').cpus().length)"
        node -e "console.log('Total Memory:', require('os').totalmem() / 1024 / 1024 / 1024, 'GB')"
        node -e "console.log('Free Memory:', require('os').freemem() / 1024 / 1024 / 1024, 'GB')"
